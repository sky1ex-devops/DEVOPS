#docker 

Мультистейдж сборка — это подход, который позволяет создавать более легковесные и оптимизированные образы [[Docker]] за счет использования нескольких этапов сборки в одном Dockerfile. Этот метод помогает уменьшить размер конечного образа, убирая необходимость включать в него все инструменты и зависимости, которые нужны только во время сборки, но не требуются для работы самого приложения.

Как он работаетДобавили все необходимые инструменты, код и зависимости в один образ, который в результате мог бы стать достаточно объемным. Мультистейдж сборка позволяет разделить этот процесс на несколько этапов, каждый из которых создает временный образ, используемый для определенных задач сборки, тестирования или других процессов. После завершения этих процессов, только нужные файлы копируются в конечный образ.

```dockerfile
# Этап 1: Сборка зависимостей
FROM node:12 AS builder
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm install

# Копирование исходного кода и сборка приложения
COPY . .
RUN npm run build

# Этап 2: Создание конечного образа
FROM node:12-slim
WORKDIR /app
COPY --from=builder /app/build ./build
COPY --from=builder /app/node_modules ./node_modules

# Запуск приложения
CMD ["node", "build/app.js"]
```

В этом примере:

- **Этап 1:** используется полноценный образ Node.js для установки зависимостей и сборки приложения. Все исходные файлы и зависимости копируются и устанавливаются в этом этапе.
- **Этап 2:** создается новый, более легкий образ (node-slim), в который копируются только необходимые для выполнения приложения файлы — скомпилированный код и папка node_modules. Это значительно сокращает размер конечного образа, так как в нем нет лишних файлов и инструментов, нужных только для сборки.

Преимущества:

**1. Уменьшение размера образа:** Убирает неиспользуемые файлы и инструменты из конечного образа, сокращая его размер и улучшая время развертывания.  
**2. Безопасность:** Уменьшает количество потенциальных уязвимостей, так как в конечном образе меньше компонентов, которые могут быть атакованы.  
**3. Упрощение управления зависимостями:** Разделяет зависимости сборки и выполнения, что облегчает управление Dockerfile и улучшает читаемость.

Мультистейдж сборка — это метод, позволяющий создавать более компактные и безопасные Docker образы, разделяя процесс сборки на несколько этапов, каждый из которых отвечает за свои задачи. Это улучшает как управление инфраструктурой, так и общую эффективность работы с контейнерами.